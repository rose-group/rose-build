version: '3'

vars:
  GOOS: "{{default OS .GOOS}}"
  MVN: '{{if eq .GOOS "windows"}}mvnw.cmd -B -ntp{{else}}./mvnw -B -ntp{{end}}'
  SLEEP: '{{if eq .GOOS "windows"}}timeout{{else}}sleep{{end}}'

tasks:
  default:
    cmds:
      - task: test

  test:
    deps: [ format ]
    cmds:
      - "{{.MVN}} clean verify"

  format:
    cmds:
      - "{{.MVN}} spotless:apply"

  release-perform:
    cmds:
      - "{{.MVN}} release:clean release:prepare"
      - "{{.MVN}} release:perform"

  deploy-local:
    deps: [ test ]
    cmds:
      - "{{.MVN}} deploy"

  deploy-central:
    deps: [ test ]
    cmds:
      - "{{.MVN}} deploy -Prelease"

  sonar:
    cmds:
      - "{{.MVN}} sonar:sonar -Dsonar.token=$SONAR_TOKEN"
